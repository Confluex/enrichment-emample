<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:json="http://www.mulesoft.org/schema/mule/json"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:munit="http://www.mulesoft.org/schema/mule/munit" xmlns:spring="http://www.springframework.org/schema/beans" xmlns:core="http://www.mulesoft.org/schema/mule/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
    <munit:config name="munit" doc:name="MUnit configuration"/>
    <spring:beans>
        <spring:import resource="classpath:enrichment-example.xml"/>
        <spring:import resource="classpath:usps-lookup.xml"/>
    </spring:beans>
    <munit:test name="usps-city-state-lookup-Test" description="Test">
        <flow-ref name="setup-single-record-message" doc:name="setup-single-record-message"/>
        <flow-ref name="usps-city-state-lookup" doc:name="usps-city-state-lookup"/>
        <flow-ref name="verify-usps-lookup-message" doc:name="verify-usps-lookup-message"/>
    </munit:test>
    <munit:test name="single-address-enricher-Test" description="Test">
        <flow-ref name="setup-single-record-message" doc:name="setup-single-record-message"/>
        <flow-ref name="address-enricher-flow" doc:name="address-enricher-flow"/>
        <flow-ref name="verify-single-record-message" doc:name="verify-single-record-message"/>
    </munit:test>
    <munit:test name="multiple-address-enricher-Test" description="Test">
        <flow-ref name="setup-multiple-record-message" doc:name="setup-multiple-record-message"/>
        <flow-ref name="multiple-address-enricher-flow" doc:name="multiple-address-enricher-flow"/>
        <flow-ref name="verify-multiple-record-message" doc:name="verify-multiple-record-message"/>
    </munit:test>
    <munit:test name="dataweave-address-enricher-Test" description="Test">
        <flow-ref name="setup-multiple-record-message" doc:name="setup-multiple-record-message"/>
        <flow-ref name="dataweave-multiple-address-enricher-flow" doc:name="dataweave-multiple-address-enricher-flow"/>
        <flow-ref name="verify-multiple-record-message" doc:name="verify-multiple-record-message"/>
    </munit:test>
    <sub-flow name="setup-single-record-message">
        <munit:set payload="#[getResource('address.json').asStream()]" doc:name="Set Message: zip=02861"/>
        <json:json-to-object-transformer returnClass="java.util.HashMap" mimeType="*/*" doc:name="JSON to Object"/>
    </sub-flow>
    <sub-flow name="setup-multiple-record-message">
        <munit:set payload="#[getResource('addresses.json').asStream()]" doc:name="Set Message: zip=02861,42223"/>
        <json:json-to-object-transformer returnClass="java.util.HashMap" mimeType="*/*" doc:name="JSON to Object"/>
    </sub-flow>
    <sub-flow name="verify-usps-lookup-message">
        <munit:assert-on-equals expectedValue="PAWTUCKET" actualValue="#[xpath3('/CityStateLookupResponse/ZipCode/City')]" doc:name="Assert Equals: City=PAWTUCKET"/>
        <munit:assert-on-equals expectedValue="RI" actualValue="#[xpath3('/CityStateLookupResponse/ZipCode/State')]" doc:name="Assert Equals: State=RI"/>
        <munit:assert-on-equals expectedValue="02861" actualValue="#[xpath3('/CityStateLookupResponse/ZipCode/Zip5')]" doc:name="Assert Equals: Zip5=02861"/>
    </sub-flow>
    <sub-flow name="verify-single-record-message">
        <munit:assert-on-equals expectedValue="Ralph" actualValue="#[payload.name]" doc:name="Assert Equals: name=Ralph"/>
        <munit:assert-on-equals expectedValue="PAWTUCKET" actualValue="#[payload.city]" doc:name="Assert Equals: City=PAWTUCKET"/>
        <munit:assert-on-equals expectedValue="RI" actualValue="#[payload.state]" doc:name="Assert Equals: state=RI"/>
        <munit:assert-on-equals expectedValue="02861" actualValue="#[payload.zip]" doc:name="Assert Equals: zip=02861"/>
    </sub-flow>
    <sub-flow name="verify-multiple-record-message">
        <munit:assert-on-equals expectedValue="#[2]" actualValue="#[payload.addresses.size()]" doc:name="Assert Equals: items in map=2"/>
        <munit:assert-on-equals expectedValue="Ralph" actualValue="#[payload.addresses[0].name]" doc:name="Assert Equals: name=Ralph"/>
        <munit:assert-on-equals expectedValue="PAWTUCKET" actualValue="#[payload.addresses[0].city]" doc:name="Assert Equals: City=PAWTUCKET"/>
        <munit:assert-on-equals expectedValue="RI" actualValue="#[payload.addresses[0].state]" doc:name="Assert Equals: state=RI"/>
        <munit:assert-on-equals expectedValue="02861" actualValue="#[payload.addresses[0].zip]" doc:name="Assert Equals: zip=02861"/>
        <munit:assert-on-equals expectedValue="George" actualValue="#[payload.addresses[1].name]" doc:name="Assert Equals: name=George"/>
        <munit:assert-on-equals expectedValue="FORT CAMPBELL" actualValue="#[payload.addresses[1].city]" doc:name="Assert Equals: City=FORT CAMPBELL"/>
        <munit:assert-on-equals expectedValue="KY" actualValue="#[payload.addresses[1].state]" doc:name="Assert Equals: state=KY"/>
        <munit:assert-on-equals expectedValue="42223" actualValue="#[payload.addresses[1].zip]" doc:name="Assert Equals: zip=42223"/>
    </sub-flow>
    
</mule>
